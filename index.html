<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizon Pierre | La Suite Immobili√®re</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* --- DESIGN SYSTEM PREMIUM (v21) --- */
        :root {
            --primary-dark: #0f172a;       /* Bleu nuit */
            --primary-blue: #3b82f6;       /* Bleu action */
            --accent-gold: #f59e0b;        /* Or */
            --bg-body: #f8fafc;            /* Gris tr√®s clair */
            --text-main: #334155;
            --text-muted: #64748b;
            
            --success: #10b981;
            --danger: #ef4444;

            --chart-capital: #10b981;
            --chart-interest: #3b82f6;
            --chart-insurance: #6366f1;
            
            --dpe-a: #009c3d; --dpe-b: #51b94d; --dpe-c: #ccce29;
            --dpe-d: #f3e500; --dpe-e: #fcc900; --dpe-f: #eb8c00; --dpe-g: #d7221f;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- LAYOUT --- */
        .top-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        .header-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .site-wrapper {
            max-width: 1100px;
            margin: 40px auto;
            padding: 0 20px;
            flex: 1; 
            width: 100%;
            box-sizing: border-box;
        }

        .site-footer {
            background: var(--primary-dark);
            color: white;
            padding: 40px 0;
            margin-top: 60px;
        }

        .footer-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 40px;
            font-size: 0.9em;
        }
        .footer-col h4 { color: var(--primary-blue); margin-top: 0; text-transform: uppercase; letter-spacing: 1px; }
        .footer-col ul { list-style: none; padding: 0; }
        .footer-col li { margin-bottom: 10px; opacity: 0.8; cursor: pointer; transition: opacity 0.2s; }
        .footer-col li:hover { opacity: 1; color: var(--primary-blue); }

        .brand { 
            font-size: 1.5em; 
            font-weight: 800; 
            color: var(--primary-dark); 
            letter-spacing: -1px; 
            text-transform: uppercase; 
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand span { color: var(--primary-blue); }
        .brand:hover { opacity: 0.8; }

        .main-nav { display: flex; gap: 5px; }
        .nav-link { padding: 8px 16px; text-decoration: none; color: var(--text-muted); font-weight: 600; font-size: 0.9em; border-radius: 8px; transition: all 0.2s ease; cursor: pointer; }
        .nav-link:hover { background: #f1f5f9; color: var(--primary-dark); }
        .nav-link.active { background-color: var(--primary-dark); color: white; }

        /* --- UI COMPONENTS --- */
        .glass-panel { background: white; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); padding: 30px; transition: transform 0.2s; }
        .glass-panel:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .btn-primary { background: var(--primary-blue); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; padding: 10px; border-radius: 10px; width: 100%; cursor: pointer; margin-top: 10px; font-weight: 600; }
        .btn-outline:hover { background: rgba(255,255,255,0.1); }
        .btn-ghost { background: transparent; border: 1px solid #cbd5e1; color: var(--text-muted); padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9em; }
        .btn-ghost:hover { border-color: var(--primary-dark); color: var(--primary-dark); }

        /* --- CALCULATOR --- */
        .calc-wrapper { display: grid; grid-template-columns: 1fr 380px; gap: 30px; align-items: start; }
        .input-section { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .sticky-results { position: sticky; top: 100px; background: var(--primary-dark); color: white; border-radius: 16px; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; font-size: 0.9em; color: var(--text-muted); }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; font-family: 'Inter', sans-serif; box-sizing: border-box; transition: border-color 0.2s; }
        .form-control:focus { border-color: var(--primary-blue); outline: none; }

        /* SLIDERS FIX */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin-top: 10px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #cbd5e1; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 20px; width: 20px; border-radius: 50%; background: var(--primary-blue); cursor: pointer; -webkit-appearance: none; margin-top: -7px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 2px solid white; }
        input[type=range]::-moz-range-track { width: 100%; height: 6px; cursor: pointer; background: #cbd5e1; border-radius: 3px; }
        input[type=range]::-moz-range-thumb { height: 20px; width: 20px; border: 2px solid white; border-radius: 50%; background: var(--primary-blue); cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .donut-chart { width: 180px; height: 180px; border-radius: 50%; margin: 0 auto 20px auto; position: relative; background: conic-gradient(var(--chart-capital) 0% 60%, var(--chart-interest) 60% 90%, var(--chart-insurance) 90% 100%); }
        .donut-hole { width: 140px; height: 140px; background: var(--primary-dark); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .main-metric { font-size: 1.8em; font-weight: 800; color: white; line-height: 1; }

        /* SAVED & MODALS */
        .saved-section { margin-top: 30px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .saved-list { display: grid; gap: 10px; margin-top: 10px; }
        .saved-card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .saved-card:hover { background: #f1f5f9; border-color: var(--primary-blue); }
        .saved-info { display: flex; flex-direction: column; }
        .saved-name { font-weight: 700; color: var(--primary-dark); font-size: 0.9em; }
        .saved-detail { font-size: 0.8em; color: var(--text-muted); }
        .delete-btn { color: #cbd5e1; cursor: pointer; font-size: 1.2em; padding: 5px; }
        .delete-btn:hover { color: var(--danger); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .table-responsive { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .table-responsive th { text-align: left; padding: 12px; background: #f1f5f9; color: var(--text-muted); font-weight: 600; position: sticky; top: 0; }
        .table-responsive td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .close-modal { cursor: pointer; font-size: 1.5em; color: var(--text-muted); background: none; border: none; }

        .dpe-badge { font-size: 4em; font-weight: 800; color: white; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; border-radius: 20px; margin: 0 auto 20px auto; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid var(--primary-blue); width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .calc-wrapper { grid-template-columns: 1fr; }
            .sticky-results { position: relative; top: 0; margin-top: 20px; }
            .header-inner { flex-direction: column; gap: 15px; }
            .main-nav { width: 100%; justify-content: center; overflow-x: auto; }
            .footer-inner { grid-template-columns: 1fr; text-align: center; }
        }
    </style>
</head>
<body>

    <!-- TOP BAR -->
    <nav class="top-bar">
        <div class="header-inner">
            <div class="brand" onclick="navTo('home', null)">
                <span style="font-size:1.5em;">üèõÔ∏è</span> Horizon <span>Pierre</span>
            </div>
            <div class="main-nav">
                <a class="nav-link active" onclick="navTo('home', this)">Accueil</a>
                <a class="nav-link" onclick="navTo('calculator', this)">Cr√©dit</a>
                <a class="nav-link" onclick="navTo('patrimoine', this)">Rentabilit√©</a>
                <a class="nav-link" onclick="navTo('dpe', this)">DPE</a>
            </div>
        </div>
    </nav>

    <div class="site-wrapper">
        
        <!-- ACCUEIL -->
        <section id="home-page">
            <div style="text-align: center; padding: 60px 20px;">
                <h1 style="font-size: 3em; color: var(--primary-dark); margin-bottom: 10px; line-height: 1.1;">L'Intelligence Artificielle<br>de votre Patrimoine.</h1>
                <p style="font-size: 1.2em; color: var(--text-muted); margin-bottom: 40px;">Simulez, optimisez et validez vos investissements avec la pr√©cision d'un banquier.</p>
                <button class="btn-primary" style="width: fit-content; margin: 0 auto;" onclick="navTo('calculator', document.querySelectorAll('.nav-link')[1])">D√©marrer une simulation ‚Üí</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                <div class="glass-panel" onclick="navTo('calculator', document.querySelectorAll('.nav-link')[1])" style="cursor: pointer;">
                    <span style="font-size: 2em;">üè¶</span>
                    <h3>Simulateur Bancaire</h3>
                    <p style="color:var(--text-muted)">Calcul de mensualit√©, capacit√© d'emprunt et tableau d'amortissement d√©taill√©.</p>
                </div>
                <div class="glass-panel" onclick="navTo('patrimoine', document.querySelectorAll('.nav-link')[2])" style="cursor: pointer;">
                    <span style="font-size: 2em;">üìà</span>
                    <h3>Cashflow Locatif</h3>
                    <p style="color:var(--text-muted)">Analysez la rentabilit√© r√©elle (Pinel, LMNP) et votre effort d'√©pargne.</p>
                </div>
                <div class="glass-panel" onclick="navTo('dpe', document.querySelectorAll('.nav-link')[3])" style="cursor: pointer;">
                    <span style="font-size: 2em;">üå°Ô∏è</span>
                    <h3>Audit DPE</h3>
                    <p style="color:var(--text-muted)">Estimez la classe √©nerg√©tique en 3 clics et √©vitez les passoires thermiques.</p>
                </div>
            </div>
        </section>

        <!-- CALCULATEUR -->
        <section id="calculator-page" style="display: none;">
            <div class="calc-wrapper">
                <div class="input-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 style="margin:0; color:var(--primary-dark);">Financement</h2>
                        <div style="background:#f1f5f9; padding:4px; border-radius:8px;">
                            <button id="btn-mens" style="padding:6px 12px; border:none; border-radius:6px; font-weight:600; cursor:pointer;" onclick="setMode('mensualite')">Mensualit√©</button>
                            <button id="btn-cap" style="padding:6px 12px; border:none; border-radius:6px; font-weight:600; cursor:pointer; background:transparent; color:#64748b;" onclick="setMode('capacite')">Capacit√©</button>
                        </div>
                    </div>

                    <form onsubmit="return false;">
                        <div class="form-group">
                            <label>Revenus Nets Foyer <span id="rev_val">4 500 ‚Ç¨</span></label>
                            <input type="range" id="revenus" min="1500" max="15000" step="100" value="4500" oninput="updateVal('rev_val', this.value, ' ‚Ç¨'); calculate()">
                        </div>

                        <div id="wrapper-prix">
                            <div class="form-group">
                                <label>Prix du Bien <span id="prix_val">250 000 ‚Ç¨</span></label>
                                <input type="number" id="prix_bien" class="form-control" value="250000" oninput="document.getElementById('prix_val').innerText = formatMoney(this.value) + ' ‚Ç¨'; calculate()">
                            </div>
                        </div>
                        
                        <div id="wrapper-budget" style="display:none;">
                            <div class="form-group">
                                <label style="color:var(--primary-blue);">Budget Mensuel Max</label>
                                <input type="number" id="budget_mensuel" class="form-control" value="1200" oninput="calculate()">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label>Apport</label>
                                <input type="number" id="apport" class="form-control" value="40000" oninput="calculate()">
                            </div>
                            <div class="form-group">
                                <label>Frais Agence (Inclus)</label>
                                <input type="number" id="agence" class="form-control" value="10000" oninput="calculate()">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Dur√©e : <span id="duree_val">20</span> ans</label>
                            <input type="range" id="duree" min="7" max="30" value="20" oninput="updateVal('duree_val', this.value, ''); calculate()">
                        </div>
                        <div class="form-group">
                            <label>Taux : <span id="taux_val" style="color:var(--primary-blue);">3.20 %</span></label>
                            <input type="range" id="taux" min="1.0" max="5.5" step="0.05" value="3.20" oninput="document.getElementById('taux_val').innerText = parseFloat(this.value).toFixed(2) + ' %'; calculate()">
                        </div>
                    </form>

                    <div class="saved-section">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h4 style="margin:0;">Mes Sc√©narios</h4>
                            <button class="btn-ghost" onclick="saveScenario()">+ Sauvegarder</button>
                        </div>
                        <div class="saved-list" id="saved-list"></div>
                    </div>
                </div>

                <div class="sticky-results">
                    <div class="donut-chart" id="chart-bg">
                        <div class="donut-hole">
                            <span class="main-metric" id="res_mensualite">0 ‚Ç¨</span>
                            <span style="font-size:0.8em; opacity:0.7;">PAR MOIS</span>
                        </div>
                    </div>
                    
                    <div id="badge_endettement" style="background:rgba(16,185,129,0.2); color:#34d399; display:inline-block; padding:5px 10px; border-radius:20px; font-weight:bold; font-size:0.9em;">
                        33% Endettement
                    </div>

                    <div style="margin-top:20px; text-align:left; border-top:1px solid rgba(255,255,255,0.2); padding-top:15px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="opacity:0.7;">Frais Notaire (?)</span>
                            <span style="font-weight:700;" id="res_notaire">0 ‚Ç¨</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="opacity:0.7;">Frais Agence (inclus)</span>
                            <span style="font-weight:700;" id="res_agence_display">10 000 ‚Ç¨</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="opacity:0.7;">Co√ªt Cr√©dit</span>
                            <span style="font-weight:700;" id="res_cout">0 ‚Ç¨</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:1.1em; color:var(--accent-gold); margin-top:10px;">
                            <span>√Ä Financer</span>
                            <span style="font-weight:800;" id="res_financer">0 ‚Ç¨</span>
                        </div>
                        
                        <div id="res_capacite_box" style="display:none; background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; margin-top:15px; text-align:center;">
                            <small>Budget Achat Max</small><br>
                            <strong style="font-size:1.4em; color:var(--success);" id="res_capacite_achat">0 ‚Ç¨</strong>
                        </div>
                    </div>

                    <button class="btn-primary" style="margin-top:20px;" onclick="openTableModal()">
                        <span>üìä</span> Voir le Tableau d'Amortissement
                    </button>
                    <button class="btn-outline" onclick="generatePDF()">
                        <span class="loader" id="pdf-loader"></span>
                        <span id="pdf-btn-text">üì• T√©l√©charger le Dossier PDF</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- INVESTISSEMENT -->
        <section id="patrimoine-page" style="display: none;">
            <div class="calc-wrapper">
                <div class="input-section">
                    <h2>Calculateur Rentabilit√©</h2>
                    <div class="form-group"><label>Prix Achat</label><input type="number" id="y_prix" class="form-control" value="200000" oninput="calcYield()"></div>
                    <div class="form-group"><label>Loyer Mensuel (CC)</label><input type="number" id="y_loyer" class="form-control" value="950" oninput="calcYield()"></div>
                    <div class="form-group"><label>Charges Annuelles</label><input type="number" id="y_charges" class="form-control" value="1500" oninput="calcYield()"></div>
                    <div class="form-group"><label>Mensualit√© Cr√©dit (Optionnel)</label><input type="number" id="y_credit" class="form-control" value="850" oninput="calcYield()"></div>
                </div>
                <div class="sticky-results">
                    <div style="opacity:0.8;">RENTABILIT√â BRUTE</div>
                    <div style="font-size:3em; font-weight:800; color:var(--accent-gold); line-height:1;" id="y_brut">5.7%</div>
                    <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:12px; margin:20px 0;">
                        <div style="font-size:1.5em; font-weight:700;" id="y_cashflow">+ 100 ‚Ç¨</div>
                        <small>CASHFLOW / MOIS</small>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:0 20px;">
                        <div><strong id="y_net">4.9%</strong><br><small>Net</small></div>
                        <div><strong id="y_revenu">11.4k</strong><br><small>Revenu/an</small></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- DPE -->
        <section id="dpe-page" style="display:none;">
            <div class="calc-wrapper">
                <div class="input-section">
                    <h2>Audit √ânerg√©tique</h2>
                    <div class="form-group">
                        <label>Construction</label>
                        <select id="dpe_annee" class="form-control" onchange="calcDPE()">
                            <option value="1970">Avant 1974 (Non isol√©)</option>
                            <option value="1990">1975-2000 (Moyen)</option>
                            <option value="2010" selected>2000-2012 (Bon)</option>
                            <option value="2020">R√©cent (Tr√®s bon)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Chauffage</label>
                        <select id="dpe_chauffage" class="form-control" onchange="calcDPE()">
                            <option value="elec">√âlectrique</option>
                            <option value="gaz">Gaz</option>
                            <option value="pac">Pompe √† Chaleur</option>
                        </select>
                    </div>
                </div>
                <div class="sticky-results">
                    <div style="opacity:0.8; margin-bottom:10px;">ESTIMATION</div>
                    <div class="dpe-badge" id="dpe_badge" style="background:var(--dpe-c);">C</div>
                    <div id="dpe_text" style="font-weight:600;">Logement √©conome</div>
                </div>
            </div>
        </section>

    </div>

    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-col">
                <h4>Horizon Pierre</h4>
                <p style="opacity:0.7; line-height:1.6;">L'outil de r√©f√©rence pour les investisseurs immobiliers intelligents. Pr√©cision bancaire, design moderne.</p>
            </div>
            <div class="footer-col">
                <h4>Outils</h4>
                <ul>
                    <li onclick="navTo('calculator', document.querySelectorAll('.nav-link')[1])">Simulateur Cr√©dit</li>
                    <li onclick="navTo('patrimoine', document.querySelectorAll('.nav-link')[2])">Rentabilit√© Locative</li>
                    <li onclick="navTo('dpe', document.querySelectorAll('.nav-link')[3])">Audit DPE</li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>L√©gal</h4>
                <ul>
                    <li>Mentions L√©gales</li>
                    <li>Politique de Confidentialit√©</li>
                    <li>&copy; 2025 Horizon Pierre</li>
                </ul>
            </div>
        </div>
    </footer>

    <!-- MODAL AMORTISSEMENT -->
    <div id="table-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="margin:0; color:var(--primary-dark);">Tableau d'Amortissement (Annuel)</h3>
                <button class="close-modal" onclick="closeTableModal()">√ó</button>
            </div>
            <div class="modal-body">
                <table class="table-responsive">
                    <thead><tr><th>Ann√©e</th><th>Restant D√ª</th><th>Mensualit√©</th><th>Int√©r√™ts</th><th>Capital</th></tr></thead>
                    <tbody id="amortization-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- NAVIGATION ---
        function navTo(page, el) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            document.getElementById(page + (page==='home'?'-page':'-page')).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if(el) el.classList.add('active');
            window.scrollTo(0, 0);
            if(page==='calculator') calculate();
            if(page==='patrimoine') calcYield();
            if(page==='dpe') calcDPE();
        }

        // --- CALCULATOR ENGINE ---
        let mode = 'mensualite';
        const formatMoney = (n) => parseFloat(n).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        const updateVal = (id, val, suffix) => document.getElementById(id).innerText = formatMoney(val) + suffix;

        function setMode(m) {
            mode = m;
            document.getElementById('btn-mens').style.background = m==='mensualite' ? '#fff' : 'transparent';
            document.getElementById('btn-mens').style.color = m==='mensualite' ? '#0f172a' : '#64748b';
            document.getElementById('btn-cap').style.background = m==='capacite' ? '#fff' : 'transparent';
            document.getElementById('btn-cap').style.color = m==='capacite' ? '#0f172a' : '#64748b';
            
            if(m === 'capacite') {
                document.getElementById('wrapper-prix').style.display='none';
                document.getElementById('wrapper-budget').style.display='block';
                document.getElementById('res_capacite_box').style.display='block';
                document.getElementById('res_financer').parentElement.style.display='none';
            } else {
                document.getElementById('wrapper-prix').style.display='block';
                document.getElementById('wrapper-budget').style.display='none';
                document.getElementById('res_capacite_box').style.display='none';
                document.getElementById('res_financer').parentElement.style.display='flex';
            }
            calculate();
        }

        function calculate() {
            const rev = parseFloat(document.getElementById('revenus').value) || 0;
            const apport = parseFloat(document.getElementById('apport').value) || 0;
            const agence = parseFloat(document.getElementById('agence').value) || 0;
            const duree = parseFloat(document.getElementById('duree').value) || 20;
            const taux = parseFloat(document.getElementById('taux').value) / 100;
            const t_ass = 0.0034;
            const t_notaire = 0.075; 

            let K = 0, prix = 0, m_pret = 0, m_tot = 0, notaire = 0;

            if(mode === 'mensualite') {
                prix = parseFloat(document.getElementById('prix_bien').value) || 0;
                notaire = prix * t_notaire;
                let besoin = prix + notaire + agence;
                K = Math.max(0, besoin - apport);
                let tm = taux/12;
                let mois = duree*12;
                if(K>0) m_pret = (K * tm) / (1 - Math.pow(1+tm, -mois));
            } else {
                let budget = parseFloat(document.getElementById('budget_mensuel').value) || 0;
                m_tot = budget;
                let mois = duree*12;
                let tm = taux/12;
                let facteur = (tm / (1 - Math.pow(1+tm, -mois))) + (t_ass/12);
                K = budget / facteur;
                prix = (K + apport - agence) / (1 + t_notaire);
                if(prix < 0) prix = 0;
                notaire = prix * t_notaire;
                m_pret = budget - (K * t_ass / 12);
                document.getElementById('res_capacite_achat').innerText = formatMoney(prix) + " ‚Ç¨";
            }

            let m_ass = (K * t_ass) / 12;
            if(mode === 'mensualite') m_tot = m_pret + m_ass;
            let cout_credit = (m_tot * duree * 12) - K;

            document.getElementById('res_mensualite').innerText = formatMoney(m_tot) + " ‚Ç¨";
            document.getElementById('res_notaire').innerText = formatMoney(notaire) + " ‚Ç¨";
            document.getElementById('res_agence_display').innerText = formatMoney(agence) + " ‚Ç¨"; // Added Agency Display
            document.getElementById('res_financer').innerText = formatMoney(K) + " ‚Ç¨";
            document.getElementById('res_cout').innerText = formatMoney(cout_credit) + " ‚Ç¨";

            let endettement = 0;
            if(rev > 0) endettement = (m_tot / rev) * 100;
            let badge = document.getElementById('badge_endettement');
            badge.innerText = endettement.toFixed(1) + "% Endettement";
            if(endettement <= 35) { badge.style.background = "rgba(16,185,129,0.2)"; badge.style.color="#34d399"; }
            else { badge.style.background = "rgba(239,68,68,0.2)"; badge.style.color="#f87171"; }

            let p_int = 30; 
            document.getElementById('chart-bg').style.background = `conic-gradient(var(--chart-capital) 0% 60%, var(--chart-interest) 60% 90%, var(--chart-insurance) 90% 100%)`;
            
            // Storing agence in window.lastCalc for PDF
            window.lastCalc = { K, taux, duree, m_pret, m_tot, m_ass, notaire, cout_credit, prix, agence, apport };
        }

        // --- AMORTIZATION ---
        function openTableModal() { document.getElementById('table-modal').style.display = 'flex'; generateTable(); }
        function closeTableModal() { document.getElementById('table-modal').style.display = 'none'; }
        function generateTable() {
            let { K, taux, duree, m_pret } = window.lastCalc || {};
            if(!K) return;
            let html = '';
            let solde = K;
            let tm = taux / 12;
            for(let an=1; an<=duree; an++) {
                let int_an = 0; let cap_an = 0;
                for(let m=0; m<12; m++) {
                    let int = solde * tm; let cap = m_pret - int;
                    if(an===duree && m===11) cap = solde;
                    int_an += int; cap_an += cap; solde -= cap;
                    if(solde < 0) solde = 0;
                }
                html += `<tr><td>Ann√©e ${an}</td><td>${formatMoney(solde)} ‚Ç¨</td><td>${formatMoney(m_pret)} ‚Ç¨</td><td>${formatMoney(int_an)} ‚Ç¨</td><td><strong style="color:var(--success)">${formatMoney(cap_an)} ‚Ç¨</strong></td></tr>`;
            }
            document.getElementById('amortization-body').innerHTML = html;
        }

        // --- SAVES ---
        function saveScenario() {
            let name = prompt("Nom du sc√©nario:");
            if(!name) return;
            let saves = JSON.parse(localStorage.getItem('hp_saves') || '[]');
            saves.push({ name, date: new Date().toLocaleDateString(), prix: document.getElementById('prix_bien').value, mensualite: document.getElementById('res_mensualite').innerText });
            localStorage.setItem('hp_saves', JSON.stringify(saves));
            renderSaves();
        }
        function renderSaves() {
            let saves = JSON.parse(localStorage.getItem('hp_saves') || '[]');
            let div = document.getElementById('saved-list');
            div.innerHTML = '';
            saves.forEach((s, idx) => {
                div.innerHTML += `<div class="saved-card" onclick="loadSave(${idx})"><div class="saved-info"><span class="saved-name">${s.name}</span><span class="saved-detail">${s.mensualite} ‚Ä¢ ${s.date}</span></div><span class="delete-btn" onclick="deleteSave(event, ${idx})">√ó</span></div>`;
            });
        }
        function deleteSave(e, idx) { e.stopPropagation(); let saves = JSON.parse(localStorage.getItem('hp_saves') || '[]'); saves.splice(idx, 1); localStorage.setItem('hp_saves', JSON.stringify(saves)); renderSaves(); }

        // --- PDF V3 (PEDAGOGIQUE & COMPLET) ---
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = window.lastCalc;
            if (!data || !data.K) { alert("Veuillez faire une simulation."); return; }
            
            const btnText = document.getElementById('pdf-btn-text');
            const loader = document.getElementById('pdf-loader');
            btnText.innerText = "G√©n√©ration...";
            loader.style.display = "inline-block";

            // En-t√™te
            doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 35, 'F');
            doc.setFont("helvetica", "bold"); doc.setFontSize(20); doc.setTextColor(255, 255, 255);
            doc.text("HORIZON PIERRE", 15, 18);
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text("√âtude de Financement Immobilier", 15, 26);
            doc.text(`Le ${new Date().toLocaleDateString()}`, 170, 18);

            let y = 50;

            // SECTION 1: LE CO√õT (Ce que je paie)
            doc.setTextColor(0); doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text("1. Co√ªt Total de l'Op√©ration (Ce que vous achetez)", 15, y);
            doc.setLineWidth(0.5); doc.line(15, y+2, 195, y+2);
            y += 10;
            
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text("Prix Net Vendeur :", 20, y); doc.text(`${formatMoney(data.prix)} ‚Ç¨`, 160, y, {align:'right'}); y+=8;
            doc.text("Frais d'Agence :", 20, y); doc.text(`${formatMoney(data.agence)} ‚Ç¨`, 160, y, {align:'right'}); y+=8;
            doc.text("Frais de Notaire (Estim√©s) :", 20, y); doc.text(`${formatMoney(data.notaire)} ‚Ç¨`, 160, y, {align:'right'}); y+=10;
            
            // Total Ligne
            doc.setFillColor(240); doc.rect(15, y-6, 180, 10, 'F');
            doc.setFont("helvetica", "bold"); 
            let totalCout = parseFloat(data.prix) + parseFloat(data.agence) + parseFloat(data.notaire);
            doc.text("TOTAL DU PROJET :", 20, y); doc.text(`${formatMoney(totalCout)} ‚Ç¨`, 160, y, {align:'right'}); y+=20;

            // SECTION 2: LE FINANCEMENT (Comment je paie)
            doc.setFontSize(14); doc.text("2. Plan de Financement (Vos Ressources)", 15, y);
            doc.line(15, y+2, 195, y+2); y += 10;
            
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text("Votre Apport Personnel :", 20, y); doc.text(`- ${formatMoney(data.apport)} ‚Ç¨`, 160, y, {align:'right'}); y+=8;
            
            doc.setFillColor(230, 240, 255); doc.rect(15, y-2, 180, 14, 'F');
            doc.setFont("helvetica", "bold"); doc.setTextColor(15, 23, 42);
            doc.text("MONTANT √Ä EMPRUNTER :", 20, y+8); doc.text(`${formatMoney(data.K)} ‚Ç¨`, 160, y+8, {align:'right'}); y+=25;

            // SECTION 3: EMPRUNT
            doc.setTextColor(0);
            doc.setFontSize(14); doc.text("3. Conditions de l'Emprunt", 15, y);
            doc.line(15, y+2, 195, y+2); y += 12;

            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text(`Mensualit√© (Assurance Incluse) : ${formatMoney(data.m_tot)} ‚Ç¨ / mois`, 20, y); y+=8;
            doc.text(`Taux Nominal : ${document.getElementById('taux').value} %  |  Dur√©e : ${data.duree} ans`, 20, y); y+=8;
            doc.text(`Co√ªt total des int√©r√™ts + assurance : ${formatMoney(data.cout_credit)} ‚Ç¨`, 20, y); y+=20;

            // SECTION 4: TABLEAU COMPLET
            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text("4. Tableau d'Amortissement Pr√©visionnel (Complet)", 15, y);
            y += 5;

            // Generation des donn√©es compl√®tes (toutes les ann√©es)
            let rows = []; let solde = data.K; let tm = data.taux / 12;
            for(let an=1; an<= data.duree; an++) {
                let int_an = 0; let cap_an = 0;
                for(let m=0; m<12; m++) {
                    let int = solde * tm; let cap = data.m_pret - int;
                    int_an += int; cap_an += cap; solde -= cap; if(solde < 0) solde = 0;
                }
                rows.push([`Ann√©e ${an}`, `${formatMoney(solde)} ‚Ç¨`, `${formatMoney(int_an)} ‚Ç¨`, `${formatMoney(cap_an)} ‚Ç¨`]);
            }

            doc.autoTable({
                startY: y,
                head: [['Ann√©e', 'Capital Restant D√ª (Fin ann√©e)', 'Int√©r√™ts Pay√©s', 'Capital Rembours√©']],
                body: rows,
                theme: 'striped',
                headStyles: { fillColor: [15, 23, 42] },
                styles: { fontSize: 10, cellPadding: 3 },
                pageBreak: 'auto'
            });

            // Footer sur toutes les pages
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) { 
                doc.setPage(i); 
                doc.setFontSize(8); 
                doc.setTextColor(150); 
                doc.text(`Page ${i} / ${pageCount} - Document g√©n√©r√© par Horizon Pierre.`, 105, 285, null, null, "center"); 
            }
            
            doc.save("Etude_HorizonPierre_Complete.pdf");
            setTimeout(() => { btnText.innerText = "üì• T√©l√©charger le Dossier PDF"; loader.style.display = "none"; }, 1000);
        }

        // --- YIELD / DPE ---
        function calcYield() {
            let p = parseFloat(document.getElementById('y_prix').value);
            let l = parseFloat(document.getElementById('y_loyer').value);
            let c = parseFloat(document.getElementById('y_charges').value);
            let cred = parseFloat(document.getElementById('y_credit').value);
            let an_rent = l * 12; let brut = (an_rent / p) * 100; let net = ((an_rent - c)/p)*100; let cf = l - cred - (c/12);
            document.getElementById('y_brut').innerText = brut.toFixed(1) + "%";
            document.getElementById('y_net').innerText = net.toFixed(1) + "%";
            document.getElementById('y_revenu').innerText = (an_rent/1000).toFixed(1) + "k";
            let cfEl = document.getElementById('y_cashflow'); cfEl.innerText = (cf>0?"+":"") + Math.round(cf) + " ‚Ç¨"; cfEl.style.color = cf >= 0 ? "var(--success)" : "var(--danger)";
        }
        function calcDPE() {
            let an = parseInt(document.getElementById('dpe_annee').value); let ch = document.getElementById('dpe_chauffage').value; let score = 0;
            if(an <= 1970) score = 450; else if(an <= 1990) score = 250; else if(an <= 2010) score = 150; else score = 80;
            if(ch === 'elec') score *= 1.1; if(ch === 'pac') score *= 0.6;
            let l = 'A', c = 'var(--dpe-a)', t = 'Excellent';
            if(score > 420) { l='G'; c='var(--dpe-g)'; t='Passoire thermique'; } else if(score > 330) { l='F'; c='var(--dpe-f)'; t='Passoire thermique'; } else if(score > 250) { l='E'; c='var(--dpe-e)'; t='Moyen'; } else if(score > 180) { l='D'; c='var(--dpe-d)'; t='Standard'; } else if(score > 110) { l='C'; c='var(--dpe-c)'; t='Bon'; }
            let badge = document.getElementById('dpe_badge'); badge.innerText = l; badge.style.background = c; document.getElementById('dpe_text').innerText = t;
        }

        renderSaves(); calculate();
    </script>
</body>
</html>
