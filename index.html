<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Immobilier Gratuit | Cr√©dit, Rentabilit√© & DPE | Horizon Pierre</title> <!-- SEO Title -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* --- DESIGN SYSTEM (v37) --- */
        :root {
            --primary-dark: #0f172a;
            --primary-blue: #3b82f6;
            --accent-gold: #f59e0b;
            --bg-body: #f8fafc;
            --text-main: #334155;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --chart-capital: #10b981;
            --chart-interest: #3b82f6;
            --chart-insurance: #6366f1;
            --dpe-a: #009c3d; --dpe-b: #51b94d; --dpe-c: #ccce29;
            --dpe-d: #f3e500; --dpe-e: #fcc900; --dpe-f: #eb8c00; --dpe-g: #d7221f;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            line-height: 1.6;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* LAYOUT */
        .top-bar {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000;
        }
        .header-inner { max-width: 1100px; margin: 0 auto; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .site-wrapper { max-width: 1100px; margin: 40px auto; padding: 0 20px; flex: 1; width: 100%; box-sizing: border-box; }
        
        /* FOOTER */
        .site-footer { background: var(--primary-dark); color: white; padding: 40px 0; margin-top: 60px; }
        .footer-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 40px;
            font-size: 0.9em;
            text-align: left;
        }
        .footer-col h4 { color: var(--primary-blue); margin-top: 0; text-transform: uppercase; letter-spacing: 1px; }
        .footer-col ul { list-style: none; padding: 0; }
        .footer-col li { margin-bottom: 10px; opacity: 0.8; cursor: pointer; transition: opacity 0.2s; }
        .footer-col li:hover { opacity: 1; color: var(--primary-blue); }


        .brand { font-size: 1.5em; font-weight: 800; color: var(--primary-dark); letter-spacing: -1px; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary-blue); }
        .main-nav { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px;}
        .nav-link { padding: 8px 12px; text-decoration: none; color: var(--text-muted); font-weight: 600; font-size: 0.9em; border-radius: 8px; transition: all 0.2s; cursor: pointer; white-space: nowrap; }
        .nav-link:hover { background: #f1f5f9; color: var(--primary-dark); }
        .nav-link.active { background-color: var(--primary-dark); color: white; }

        /* UI ELEMENTS */
        .btn-primary { background: var(--primary-blue); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #e0f2fe; color: var(--primary-blue); border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-secondary:hover { background: #bae6fd; }
        .btn-affiliation { /* Style pour les boutons d'affiliation Or/Noir */
            background: var(--accent-gold); 
            color: var(--primary-dark); 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            font-weight: 700; 
            cursor: pointer; 
            width: 100%; 
            max-width: 100%; /* S√âCURIT√â CONTRE LE D√âBORDEMENT */
            display: block; 
            text-align: center;
            text-decoration: none;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            white-space: normal; /* Permet au texte de passer √† la ligne */
        }
        .btn-affiliation:hover {
            background: #d97706; /* Ton plus fonc√© */
        }

        /* CALCULATOR */
        .calc-wrapper { display: grid; grid-template-columns: 1fr 380px; gap: 30px; align-items: start; }
        .input-section { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .sticky-results { 
            position: sticky; 
            top: 100px; 
            background: var(--primary-dark); 
            color: white; 
            border-radius: 16px; 
            padding: 30px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
            text-align: center;
            overflow: hidden; 
            box-sizing: border-box; 
        }
        /* Ajustement de la largeur des boutons dans sticky-results pour les petits √©crans */
        @media (max-width: 450px) {
             .sticky-results .btn-primary, .sticky-results .btn-secondary, .sticky-results .btn-outline {
                 /* R√©duction du padding pour faire de la place aux boutons affiliation */
                 padding: 10px; 
                 font-size: 0.9em;
             }
        }
        

        .form-group { margin-bottom: 20px; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .acquisition-result { background: #e0f2fe; color: var(--primary-dark); padding: 25px; border-radius: 12px; text-align: center; margin-top: 30px; }
        .acquisition-result strong { font-size: 3em; font-weight: 800; display: block; line-height: 1.1; color: var(--success); }
        
        /* CORRECTION CSS RANGE SLIDER */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; margin-top: 10px;}
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #cbd5e1; border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb { height: 22px; width: 22px; border-radius: 50%; background: var(--primary-blue); cursor: pointer; -webkit-appearance: none; margin-top: -7px; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input[type=range]::-moz-range-track { width: 100%; height: 8px; cursor: pointer; background: #cbd5e1; border-radius: 4px; }
        input[type=range]::-moz-range-thumb { height: 22px; width: 22px; border-radius: 50%; background: var(--primary-blue); cursor: pointer; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input[type=range]::-ms-track { width: 100%; height: 8px; cursor: pointer; background: transparent; border-color: transparent; color: transparent; }

        /* MODAL CORRECTION */
        .modal-overlay { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(5px); 
            z-index: 2000; 
            display: none !important; /* CORRECTION MAJEURE: Masqu√© par d√©faut */
            align-items: center; 
            justify-content: center; 
        }
        .modal-overlay.show {
            display: flex !important; /* Affich√© uniquement par JavaScript */
        }
        .modal-card { background: white; width: 95%; max-width: 800px; max-height: 90vh; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .table-responsive { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .table-responsive th { text-align: left; padding: 12px; background: #f1f5f9; position: sticky; top: 0; }
        .table-responsive td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        
        /* Mobile */
        @media (max-width: 768px) {
            .calc-wrapper { grid-template-columns: 1fr; }
            .sticky-results { position: relative; top: 0; margin-top: 20px; }
            .header-inner { flex-direction: column; gap: 15px; }
            .main-nav { width: 100%; justify-content: flex-start; overflow-x: auto; }
            .footer-inner { grid-template-columns: 1fr; text-align: center; }
            #about-page .mission-card { padding: 20px; }
        }
    </style>
</head>
<body>

    <nav class="top-bar">
        <div class="header-inner">
            <div class="brand" onclick="navTo('home', null)">
                <span style="font-size:1.5em;">üèõÔ∏è</span> Horizon <span>Pierre</span>
            </div>
            <div class="main-nav">
                <a class="nav-link active" onclick="navTo('home', this)">Accueil</a>
                <a class="nav-link" onclick="navTo('calculator', this)">Cr√©dit</a>
                <a class="nav-link" onclick="navTo('patrimoine', this)">Rentabilit√©</a>
                <a class="nav-link" onclick="navTo('energie', this)">Audit √ânergie</a>
                <a class="nav-link" onclick="navTo('maintenance', this)">Maintenance</a>
                <a class="nav-link" onclick="navTo('acquisition', this)">Acquisition</a>
                <a class="nav-link" onclick="navTo('lexique', this)">Lexique</a>
                <a class="nav-link" onclick="navTo('about', this)">√Ä Propos</a>
            </div>
        </div>
    </nav>

    <div class="site-wrapper">
        
        <!-- ACCUEIL -->
        <section id="home-page">
            <div style="text-align: center; padding: 60px 20px;">
                <!-- Titre H1 SEO Optimis√© -->
                <h1 style="font-size: 3em; color: var(--primary-dark); margin-bottom: 10px; line-height: 1.1;">Simulateur de Cr√©dit Immobilier <br>et Outil d'Investissement Gratuit</h1>
                <p style="font-size: 1.2em; color: var(--text-muted); margin-bottom: 40px;">Calculez vos mensualit√©s, estimez la rentabilit√© apr√®s imp√¥ts (LMNP), et s√©curisez votre projet.</p>
                <!-- CALCULATEUR RAPIDE (QUICK CALC) -->
                <div class="quick-calc-box">
                    <h3>Simulateur de Mensualit√© Express</h3>
                    <div class="quick-calc-form">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Prix du Bien</label>
                            <input type="number" id="quick_prix" class="form-control" value="200000" oninput="quickCalculate()">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Apport</label>
                            <input type="number" id="quick_apport" class="form-control" value="30000" oninput="quickCalculate()">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Dur√©e (ans)</label>
                            <input type="number" id="quick_duree" class="form-control" value="20" oninput="quickCalculate()">
                        </div>
                        <div class="quick-calc-result">
                            <small style="opacity:0.7;">Mensualit√© estim√©e</small>
                            <strong id="quick_mensualite">0 ‚Ç¨</strong>
                        </div>
                    </div>
                </div>
                <!-- FIN QUICK CALC -->

                <button class="btn-primary" style="width: fit-content; margin: 0 auto 30px auto;" onclick="navTo('calculator', document.querySelectorAll('.nav-link')[1])">D√©marrer l'√©tude compl√®te ‚Üí</button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                <div class="glass-panel" onclick="navTo('calculator', document.querySelectorAll('.nav-link')[1])">
                    <span style="font-size: 2em;">üè¶</span>
                    <h3>Simulateur Bancaire</h3>
                    <p style="color:var(--text-muted)">Calcul de mensualit√©, capacit√© d'emprunt et tableau d'amortissement.</p>
                </div>
                <div class="glass-panel" onclick="navTo('patrimoine', document.querySelectorAll('.nav-link')[2])">
                    <span style="font-size: 2em;">üìà</span>
                    <h3>Rentabilit√© & Fiscalit√©</h3>
                    <p style="color:var(--text-muted)">Estimez votre Cashflow Net d'imp√¥ts (LMNP, R√©el).</p>
                </div>
                <div class="glass-panel" onclick="navTo('energie', document.querySelectorAll('.nav-link')[3])">
                    <span style="font-size: 2em;">üå°Ô∏è</span>
                    <h3>Audit √ânergie (DPE)</h3>
                    <p style="color:var(--text-muted)">Estimez la classe √©nerg√©tique en 3 clics.</p>
                </div>
                 <div class="glass-panel" onclick="navTo('maintenance', document.querySelectorAll('.nav-link')[4])">
                    <span style="font-size: 2em;">üõ†Ô∏è</span>
                    <h3>Maintenance & Risques</h3>
                    <p style="color:var(--text-muted)">Estimez la provision annuelle pour les impr√©vus (travaux, vacance).</p>
                </div>
            </div>
        </section>

        <!-- CALCULATEUR CREDIT -->
        <section id="calculator-page" style="display: none;">
            <div class="calc-wrapper">
                <div class="input-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <!-- Titre SEO : Simulateur Emprunt -->
                        <h2 style="margin:0; color:var(--primary-dark);">Simulateur d'Emprunt : Calcul de Mensualit√© & Capacit√©</h2>
                        <div style="background:#f1f5f9; padding:4px; border-radius:8px;">
                            <button id="btn-mens" style="padding:6px 12px; border:none; border-radius:6px; font-weight:600; cursor:pointer;" onclick="setMode('mensualite')">Mensualit√©</button>
                            <button id="btn-cap" style="padding:6px 12px; border:none; border-radius:6px; font-weight:600; cursor:pointer; background:transparent; color:#64748b;" onclick="setMode('capacite')">Capacit√©</button>
                        </div>
                    </div>

                    <form onsubmit="return false;">
                        <div class="form-group"><label>Revenus Nets Foyer <span id="rev_val">4 500 ‚Ç¨</span></label><input type="range" id="revenus" min="1500" max="15000" step="100" value="4500" oninput="updateVal('rev_val', this.value, ' ‚Ç¨'); calculate()"></div>
                        <div id="wrapper-prix"><div class="form-group"><label>Prix du Bien <span id="prix_val">250 000 ‚Ç¨</span></label><input type="number" id="prix_bien" class="form-control" value="250000" oninput="document.getElementById('prix_val').innerText = formatMoney(this.value) + ' ‚Ç¨'; calculate()"></div></div>
                        <div id="wrapper-budget" style="display:none;"><div class="form-group"><label style="color:var(--primary-blue);">Budget Mensuel Max</label><input type="number" id="budget_mensuel" class="form-control" value="1200" oninput="calculate()"></div></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group"><label>Apport</label><input type="number" id="apport" class="form-control" value="40000" oninput="calculate()"></div>
                            <div class="form-group"><label>Frais Agence</label><input type="number" id="agence" class="form-control" value="10000" oninput="calculate()"></div>
                        </div>
                        <div class="form-group"><label>Dur√©e : <span id="duree_val">20</span> ans</label><input type="range" id="duree" min="7" max="30" value="20" oninput="updateVal('duree_val', this.value, ''); calculate()"></div>
                        <div class="form-group"><label>Taux : <span id="taux_val" style="color:var(--primary-blue);">3.20 %</span></label><input type="range" id="taux" min="1.0" max="5.5" step="0.05" value="3.20" oninput="document.getElementById('taux_val').innerText = parseFloat(this.value).toFixed(2) + ' %'; calculate()"></div>
                    </form>
                </div>

                <div class="sticky-results">
                    <div class="donut-chart" id="chart-bg"><div class="donut-hole"><span class="main-metric" id="res_mensualite">0 ‚Ç¨</span><span style="font-size:0.8em; opacity:0.7;">PAR MOIS</span></div></div>
                    <div id="badge_endettement" style="background:rgba(16,185,129,0.2); color:#34d399; display:inline-block; padding:5px 10px; border-radius:20px; font-weight:bold; font-size:0.9em;">33% Endettement</div>
                    <div style="margin-top:20px; text-align:left; border-top:1px solid rgba(255,255,255,0.2); padding-top:15px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span style="opacity:0.7;">Notaire + Agence</span><span style="font-weight:700;" id="res_frais_annexes">0 ‚Ç¨</span></div>
                        <div style="display:flex; justify-content:space-between; font-size:1.1em; color:var(--accent-gold); margin-top:10px;"><span>√Ä Financer</span><span style="font-weight:800;" id="res_financer">0 ‚Ç¨</span></div>
                        <div id="res_capacite_box" style="display:none; background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; margin-top:15px; text-align:center;"><small>Budget Achat Max</small><br><strong style="font-size:1.4em; color:var(--success);" id="res_capacite_achat">0 ‚Ç¨</strong></div>
                    </div>
                    <!-- Bouton d'Affiliation (Correction de la taille avec la classe btn-affiliation) -->
                    <a id="btn_affiliation_courtier" href="#lien-affili√©-courtier" target="_blank" class="btn-affiliation" style="margin-top:20px;">
                        üí∞ Comparer les taux avec notre partenaire
                    </a>
                    <button class="btn-primary" style="margin-top:10px;" onclick="openTableModal()"><span>üìä</span> Tableau d'Amortissement</button>
                    <button class="btn-secondary" onclick="shareSimulation()">üîó Copier le lien</button>
                    <button class="btn-outline" onclick="generatePDF()">üì• T√©l√©charger PDF</button>

                    
                    <!-- Avertissement L√©gal -->
                    <p style="font-size:0.7em; opacity:0.6; margin-top:15px; margin-bottom:0;">
                        *Simulation √† titre indicatif, non contractuelle. Consultez toujours un professionnel du cr√©dit.
                    </p>
                </div>
            </div>
        </section>

        <!-- RENTABILITE & FISCALITE -->
        <section id="patrimoine-page" style="display: none;">
            <div class="calc-wrapper">
                <div class="input-section">
                    <!-- Titre SEO : Rentabilit√© Locative -->
                    <h2 style="color:var(--primary-dark);">Rentabilit√© Locative Nette & Fiscalit√© LMNP (R√©el/Micro)</h2>
                    <div class="form-group"><label>Prix Achat (FAI)</label><input type="number" id="y_prix" class="form-control" value="200000" oninput="calcYield()"></div>
                    <div class="form-group"><label>Loyer Mensuel (CC)</label><input type="number" id="y_loyer" class="form-control" value="950" oninput="calcYield()"></div>
                    <div class="form-group"><label>Charges Annuelles</label><input type="number" id="y_charges" class="form-control" value="1500" oninput="calcYield()"></div>
                    <div class="form-group"><label>Mensualit√© Cr√©dit</label><input type="number" id="y_credit" class="form-control" value="850" oninput="calcYield()"></div>
                    
                    <!-- FRAIS DE GESTION -->
                    <div class="form-group">
                        <label>Frais de Gestion Locative <span id="y_gestion_val">8.0</span> %</label>
                        <input type="range" id="y_gestion_rate" min="0" max="15" step="0.5" value="8.0" oninput="document.getElementById('y_gestion_val').innerText = parseFloat(this.value).toFixed(1); calcYield()">
                    </div>
                    
                    <!-- MODULE FISCALITE -->
                    <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-top:20px;">
                        <h4 style="margin-top:0; color:var(--primary-dark);">Fiscalit√© (Estimation LMNP)</h4>
                        <div class="form-group">
                            <label>Votre TMI (Tranche Marginale d'Imposition)</label>
                            <select id="y_tmi" class="form-control" onchange="calcYield()">
                                <option value="0">0 %</option>
                                <option value="11">11 %</option>
                                <option value="30" selected>30 %</option>
                                <option value="41">41 %</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>R√©gime Fiscal</label>
                            <select id="y_regime" class="form-control" onchange="calcYield()">
                                <option value="micro">Micro-BIC (Abattement 50%)</option>
                                <option value="reel">R√©el (Amortissement)</option>
                            </select>
                        </div>
                        <!-- Bouton d'Affiliation LMNP (Ajout√©) -->
                        <a id="btn_affiliation_lmnp" href="#lien-affili√©-LMNP" target="_blank" class="btn-affiliation" style="margin-top:15px;">
                            ‚öñÔ∏è Audit Fiscalit√© Offert par notre Partenaire
                        </a>
                    </div>
                </div>
                <div class="sticky-results">
                    <div style="opacity:0.8;">RENTABILIT√â BRUTE</div>
                    <div style="font-size:3em; font-weight:800; color:var(--accent-gold); line-height:1;" id="y_brut">5.7%</div>
                    
                    <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:12px; margin:20px 0;">
                        <div style="font-size:1.5em; font-weight:700;" id="y_cashflow_net">0 ‚Ç¨</div>
                        <small>CASHFLOW NET / MOIS</small>
                        <div style="font-size:0.8em; opacity:0.7; margin-top:5px;" id="y_impot_detail">Apr√®s imp√¥ts</div>
                    </div>

                    <div style="display:flex; justify-content:space-between; padding:0 20px;">
                        <div><strong id="y_net">4.9%</strong><br><small>Nette</small></div>
                        <div><strong id="y_cashflow_brut">0 ‚Ç¨</strong><br><small>CF Brut</small></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AUDIT √âNERGIE (DPE) -->
        <section id="energie-page" style="display:none;">
            <div class="calc-wrapper">
                <div class="input-section">
                    <!-- Titre SEO : Audit √ânergie DPE -->
                    <h2 style="color:var(--primary-dark);">Audit √ânergie (DPE) : Estimer la Classe √ânerg√©tique</h2>
                    <p style="color:var(--text-muted);">Estimez rapidement la classe √©nerg√©tique de votre futur bien (A √† G).</p>
                    <div class="form-group">
                        <label>Construction</label>
                        <select id="dpe_annee" class="form-control" onchange="calcDPE()">
                            <option value="1970">Avant 1974 (Non isol√©)</option>
                            <option value="1990">1975-2000 (Moyen)</option>
                            <option value="2010" selected>2000-2012 (Bon)</option>
                            <option value="2020">R√©cent (Tr√®s bon)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Chauffage</label>
                        <select id="dpe_chauffage" class="form-control" onchange="calcDPE()">
                            <option value="elec">√âlectrique</option>
                            <option value="gaz">Gaz</option>
                            <option value="pac">Pompe √† Chaleur</option>
                        </select>
                    </div>
                </div>
                <div class="sticky-results">
                    <div style="opacity:0.8;">CLASSE √âNERG√âTIQUE ESTIM√âE</div>
                    <div class="dpe-badge" id="dpe_badge" style="background:var(--dpe-c);">C</div>
                    <div id="dpe_text" style="font-weight:600;">Logement √©conome</div>
                </div>
            </div>
        </section>
        
        <!-- MAINTENANCE ET RISQUES -->
        <section id="maintenance-page" style="display:none;">
            <div class="calc-wrapper">
                <div class="input-section">
                    <!-- Titre SEO : Provision Risques -->
                    <h2 style="color:var(--primary-dark);">Provision pour Risques : Vacance Locative & Maintenance</h2>
                    <p style="color:var(--text-muted)">Anticipez les co√ªts impr√©vus et les p√©riodes sans locataire pour s√©curiser votre cashflow.</p>
                    
                    <h4 style="color:var(--primary-dark); margin-top:30px;">1. Risque de Vacance Locative</h4>
                    <div class="form-group">
                        <label>Loyer Annuel Estim√©</label>
                        <input type="number" id="maint_loyer_annuel" class="form-control" value="11400" oninput="calcMaintenance()">
                    </div>
                    <div class="form-group">
                        <label>Vacance Locative Moyenne <span id="maint_vac_val">5.0</span> %</label>
                        <input type="range" id="maint_vacance_rate" min="0" max="15" step="0.5" value="5" oninput="document.getElementById('maint_vac_val').innerText = this.value; calcMaintenance()">
                    </div>

                    <h4 style="color:var(--primary-dark); margin-top:30px;">2. Maintenance et Travaux</h4>
                    <div class="form-group">
                        <label>Prix d'Achat du Bien <span style="font-weight:normal; color:var(--text-muted);">(pour provision)</span></label>
                        <input type="number" id="maint_prix_achat" class="form-control" value="200000" oninput="calcMaintenance()">
                    </div>
                     <div class="form-group">
                        <label>√âtat G√©n√©ral du Bien</label>
                        <select id="maint_etat" class="form-control" onchange="calcMaintenance()">
                            <option value="neuf">Neuf / Moins de 5 ans (0.5% du prix)</option>
                            <option value="bon" selected>Bon / R√©cent (1.0% du prix)</option>
                            <option value="moyen">Moyen / + de 20 ans (1.5% du prix)</option>
                            <option value="vieux">√Ä R√©nover / Tr√®s Vieux (2.0% du prix)</option>
                        </select>
                    </div>

                </div>

                <div class="sticky-results">
                    <div style="opacity:0.8;">PROVISION TOTALE N√âCESSAIRE</div>
                    <div style="font-size:3em; font-weight:800; color:var(--danger); line-height:1;" id="maint_total_annuel">0 ‚Ç¨</div>
                    <small style="opacity:0.7;">PAR AN</small>

                    <div style="margin-top:30px; text-align:left; border-top:1px solid rgba(255,255,255,0.2); padding-top:15px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span style="opacity:0.7;">Provision Mensuelle</span>
                            <span style="font-weight:700;" id="maint_total_mensuel">0 ‚Ç¨</span>
                        </div>
                        <div style="margin-top:20px; font-size:0.9em;">
                            <h5 style="margin-bottom:5px;">D√©tail des Risques :</h5>
                            <div style="display:flex; justify-content:space-between; opacity:0.7; margin-bottom:5px;"><span>Vacance Locative (Annuel)</span><span id="maint_vac_annuel">0 ‚Ç¨</span></div>
                            <div style="display:flex; justify-content:space-between; opacity:0.7;"><span>Maintenance/Travaux (Annuel)</span><span id="maint_travaux_annuel">0 ‚Ç¨</span></div>
                        </div>
                    </div>
                    
                    <p style="font-size:0.8em; opacity:0.8; margin-top:30px;">*Cette somme doit id√©alement √™tre mise de c√¥t√© chaque mois pour absorber les impr√©vus sans impacter votre tr√©sorerie.</p>
                </div>
            </div>
        </section>
        
        <!-- CALCULATEUR D'ACQUISITION (NOUVEAU) -->
        <section id="acquisition-page" style="display:none;">
            <div class="calc-wrapper">
                <div class="input-section">
                    <!-- Titre SEO : Vitesse Acquisition -->
                    <h2 style="color:var(--primary-dark);">Calculateur de Vitesse d'Acquisition (Retour sur Apport)</h2>
                    <p style="color:var(--text-muted)">Calculez le temps n√©cessaire pour que le cashflow net g√©n√©r√© par votre bien immobilier reconstitue votre apport initial.</p>
                    
                    <h4 style="color:var(--primary-dark); margin-top:30px;">Donn√©es de l'Op√©ration</h4>
                    <div class="form-group">
                        <label>Apport Initial Investi</label>
                        <input type="number" id="acq_apport" class="form-control" value="40000" oninput="calcAcquisition()">
                    </div>
                    <div class="form-group">
                        <label>Cashflow Mensuel Net (apr√®s TOUTES les charges et imp√¥ts)</label>
                        <input type="number" id="acq_cashflow" class="form-control" value="150" oninput="calcAcquisition()">
                    </div>

                </div>

                <div class="sticky-results">
                    <div style="opacity:0.8;">TEMPS N√âCESSAIRE POUR RECONSTITUER L'APPORT</div>
                    <div class="acquisition-result">
                        <h3>D√©lai estim√©</h3>
                        <strong id="acq_years">0</strong>
                        <small id="acq_months">0 mois</small>
                    </div>
                    
                    <p style="font-size:0.8em; opacity:0.8; margin-top:30px;">*Ce calcul est th√©orique et ne tient pas compte de l'inflation ou de l'appr√©ciation du bien.</p>
                </div>
            </div>
        </section>


        <!-- LEXIQUE -->
        <section id="lexique-page" style="display:none;">
            <h2 style="color:var(--primary-dark); margin-bottom: 20px;">Lexique des Termes Techniques</h2>
            <div class="glass-panel">
                <div class="lexique-item">
                    <h4>Cashflow</h4>
                    <p style="color:var(--text-muted);">Le *Cashflow* (ou Flux de tr√©sorerie) est la diff√©rence entre l'argent qui entre (loyers) et l'argent qui sort (mensualit√©s de pr√™t, charges, imp√¥ts). Il peut √™tre positif (vous gagnez de l'argent chaque mois) ou n√©gatif (vous devez remettre de l'argent chaque mois).</p>
                </div>
                <div class="lexique-item">
                    <h4>TMI (Tranche Marginale d'Imposition)</h4>
                    <p style="color:var(--text-muted);">C'est le taux d'imposition le plus √©lev√© auquel sont soumis vos revenus. C'est crucial pour calculer l'imp√¥t que vous paierez sur vos loyers. Les tranches sont 0%, 11%, 30%, 41% et 45%.</p>
                </div>
                <div class="lexique-item">
                    <h4>LMNP (Loueur Meubl√© Non Professionnel)</h4>
                    <p style="color:var(--text-muted);">Un statut fiscal tr√®s avantageux pour les investisseurs qui louent un bien meubl√©. Il permet notamment, sous le r√©gime r√©el, d'amortir le prix du bien pour r√©duire fortement l'assiette imposable.</p>
                </div>
                <div class="lexique-item">
                    <h4>DPE (Diagnostic de Performance √ânerg√©tique)</h4>
                    <p style="color:var(--text-muted);">Une √©valuation de la consommation √©nerg√©tique d'un logement, class√©e de A (tr√®s √©conome) √† G (passoire thermique). C'est un crit√®re d'achat de plus en plus important en France.</p>
                </div>
                <div class="lexique-item">
                    <h4>Amortissement (R√©gime R√©el)</h4>
                    <p style="color:var(--text-muted);">M√©canisme comptable qui permet de d√©duire chaque ann√©e une partie du prix du bien (hors terrain) des revenus locatifs. C'est le principal avantage du LMNP qui permet d'√©viter l'imp√¥t sur les loyers pendant de nombreuses ann√©es.</p>
                </div>
            </div>
        </section>

        <!-- PAGE √Ä PROPOS (NOUVEAU) -->
        <section id="about-page" style="display:none;">
            <div class="mission-card">
                <h2>Notre Mission : D√©mocratiser l'Investissement.</h2>
                <p>
                    Horizon Pierre est un outil 100% gratuit, cr√©√© par des passionn√©s, pour aider les futurs propri√©taires et investisseurs √† prendre des d√©cisions √©clair√©es. Notre objectif est de transformer les calculs complexes (mensualit√©s, rentabilit√© nette, fiscalit√©) en donn√©es claires et exploitables.
                </p>

                <div class="pillars">
                    <div class="pillar-item">
                        <span style="font-size: 2em; color: var(--success);">‚úÖ</span>
                        <h4>Transparence Totale</h4>
                        <p>Nous ne sommes pas un courtier ni un cabinet de conseil. Nous sommes un outil. Nos simulations sont objectives et nos sources de revenus (liens d'affiliation) sont clairement identifi√©es.</p>
                    </div>
                    <div class="pillar-item">
                        <span style="font-size: 2em; color: var(--primary-blue);">üí°</span>
                        <h4>Clart√© & Simplicit√©</h4>
                        <p>Nous utilisons les formules bancaires standard, mais nous les pr√©sentons de la mani√®re la plus simple possible, avec des termes accessibles (voir notre Lexique).</p>
                    </div>
                    <div class="pillar-item">
                        <span style="font-size: 2em; color: var(--accent-gold);">üõ°Ô∏è</span>
                        <h4>Simulation, pas Conseil</h4>
                        <p>Les chiffres g√©n√©r√©s sont des estimations bas√©es sur vos inputs. Ils ne constituent en aucun cas un conseil financier, juridique ou fiscal. Consultez toujours un professionnel.</p>
                    </div>
                </div>
            </div>
        </section>


    </div>

    <!-- FOOTER (V√©rifi√© et corrig√©) -->
    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-col">
                <h4>Horizon Pierre</h4>
                <p style="opacity:0.7;">L'outil communautaire 100% gratuit.</p>
            </div>
            <div class="footer-col">
                <h4>Outils</h4>
                <ul>
                    <li onclick="navTo('calculator')">Simulateur</li>
                    <li onclick="navTo('patrimoine')">Rentabilit√©</li>
                    <li onclick="navTo('energie')">Audit √ânergie</li>
                    <li onclick="navTo('maintenance')">Maintenance & Risques</li>
                    <li onclick="navTo('acquisition')">Vitesse d'Acquisition</li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Aide & L√©gal</h4>
                <ul>
                    <li onclick="navTo('lexique')">Lexique des termes</li>
                    <li onclick="navTo('about')">√Ä Propos</li>
                    <li>Mentions L√©gales</li>
                    <li>Politique de Confidentialit√©</li>
                </ul>
            </div>
        </div>
    </footer>

    <!-- MODAL TABLE (D√©plac√© ici pour ne pas impacter le footer) -->
    <div id="table-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header"><h3>Tableau d'Amortissement</h3><button class="close-modal" onclick="closeTableModal()">√ó</button></div>
            <div class="modal-body"><table class="table-responsive"><thead><tr><th>Ann√©e</th><th>Restant D√ª</th><th>Mensualit√©</th><th>Int√©r√™ts</th><th>Capital</th></tr></thead><tbody id="amortization-body"></tbody></table></div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION (D√©plac√© ici) -->
    <div id="toast" class="toast">‚úÖ Lien copi√© dans le presse-papier !</div>

    <!-- CHATBASE EMBED (INTEGRATION FINALE) -->
    <script>
        window.embeddedChatbotConfig = {
            // ID OBTENU DE CHATBASE : gMr_AOgB1wlJ4_LBNeKcQ
            chatbotId: "gMr_AOgB1wlJ4_LBNeKcQ", 
            domain: "www.chatbase.co"
        }
    </script>
    <script src="https://www.chatbase.co/embed.min.js" defer></script>

    <script>
        // --- CONFIGURATION D'AFFILIATION (MODIFIER ICI) ---
        // 1. LIEN D'AFFILIATION UNIQUE vers votre courtier/banque partenaire.
        const AFFILIATION_COURTIER_URL = "https://votre-courtier-partenaire.com/comparer-taux?aff=HorizonPierre";
        
        // 2. LIEN D'AFFILIATION UNIQUE vers votre partenaire comptable LMNP.
        const AFFILIATION_LMNP_URL = "https://votre-partenaire-comptable.com/audit-lmnp?aff=HorizonPierre";


        // Mise √† jour de l'URL du bouton au chargement ou lors de la navigation
        document.addEventListener('DOMContentLoaded', () => {
            const btnCourtier = document.getElementById('btn_affiliation_courtier');
            const btnLMNP = document.getElementById('btn_affiliation_lmnp');

            if (btnCourtier) btnCourtier.href = AFFILIATION_COURTIER_URL;
            if (btnLMNP) btnLMNP.href = AFFILIATION_LMNP_URL;
            
            // Lancer les calculs initiaux (appel√© ici ou dans loadFromURL)
            loadFromURL();
            quickCalculate();
        });

        // --- QUICK CALC FUNCTION ---
        function quickCalculate() {
            const prix = parseFloat(document.getElementById('quick_prix').value) || 0;
            const apport = parseFloat(document.getElementById('quick_apport').value) || 0;
            const duree = parseFloat(document.getElementById('quick_duree').value) || 20;
            const taux = 0.035 / 100; // Taux par d√©faut simple (3.5% nominal)
            const t_ass = 0.0034;
            const t_notaire = 0.075; 
            const agence = 0; // Pas de frais d'agence dans le Quick Calc pour simplifier

            const notaire = prix * t_notaire;
            const besoin = prix + notaire + agence;
            const K = Math.max(0, besoin - apport);
            
            let m_pret = 0;
            let m_ass = 0;
            
            if (K > 0) {
                const tm = taux/12; 
                const mois = duree*12;
                m_pret = (K * tm) / (1 - Math.pow(1+tm, -mois));
                m_ass = (K * t_ass) / 12;
            }
            
            const m_tot = m_pret + m_ass;
            document.getElementById('quick_mensualite').innerText = formatMoney(m_tot) + " ‚Ç¨";
        }

        // --- CORE NAVIGATION ---
        function navTo(page, el) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            const targetId = page === 'dpe' ? 'energie' : page;
            document.getElementById(targetId + '-page').style.display = 'block';
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            // D√©finir la classe active correctement sur le lien cliqu√©
            if(el) el.classList.add('active');
            window.scrollTo(0,0);
            updateURL(page);
            
            // Lancer les calculs initiaux pour les pages
            if(targetId === 'home') quickCalculate();
            if(targetId === 'energie') calcDPE();
            if(targetId === 'maintenance') calcMaintenance();
            if(targetId === 'patrimoine') calcYield();
            if(targetId === 'acquisition') calcAcquisition();
        }

        // --- CALCULATOR & URL MANAGER ---
        let mode = 'mensualite';
        const formatMoney = (n) => parseFloat(n).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        const updateVal = (id, val, suffix) => document.getElementById(id).innerText = formatMoney(val) + suffix;

        function setMode(m) {
            mode = m;
            document.getElementById('btn-mens').style.background = m==='mensualite' ? '#fff' : 'transparent';
            document.getElementById('btn-cap').style.background = m==='capacite' ? '#fff' : 'transparent';
            
            if(m === 'capacite') {
                document.getElementById('wrapper-prix').style.display='none';
                document.getElementById('wrapper-budget').style.display='block';
                document.getElementById('res_capacite_box').style.display='block';
                document.getElementById('res_financer').parentElement.style.display='none';
            } else {
                document.getElementById('wrapper-prix').style.display='block';
                document.getElementById('wrapper-budget').style.display='none';
                document.getElementById('res_capacite_box').style.display='none';
                document.getElementById('res_financer').parentElement.style.display='flex';
            }
            calculate();
        }

        function calculate() {
            const rev = parseFloat(document.getElementById('revenus').value) || 0;
            const apport = parseFloat(document.getElementById('apport').value) || 0;
            const agence = parseFloat(document.getElementById('agence').value) || 0;
            const duree = parseFloat(document.getElementById('duree').value) || 20;
            const taux = parseFloat(document.getElementById('taux').value) / 100;
            const t_ass = 0.0034; const t_notaire = 0.075; 

            let K = 0, prix = 0, m_pret = 0, m_tot = 0, notaire = 0;

            if(mode === 'mensualite') {
                prix = parseFloat(document.getElementById('prix_bien').value) || 0;
                notaire = prix * t_notaire;
                let besoin = prix + notaire + agence;
                K = Math.max(0, besoin - apport);
                let tm = taux/12; let mois = duree*12;
                if(K>0) m_pret = (K * tm) / (1 - Math.pow(1+tm, -mois));
            } else {
                let budget = parseFloat(document.getElementById('budget_mensuel').value) || 0;
                m_tot = budget; let mois = duree*12; let tm = taux/12;
                let facteur = (tm / (1 - Math.pow(1+tm, -mois))) + (t_ass/12);
                K = budget / facteur;
                prix = (K + apport - agence) / (1 + t_notaire);
                if(prix < 0) prix = 0;
                notaire = prix * t_notaire;
                m_pret = budget - (K * t_ass / 12);
                document.getElementById('res_capacite_achat').innerText = formatMoney(prix) + " ‚Ç¨";
            }

            let m_ass = (K * t_ass) / 12;
            if(mode === 'mensualite') m_tot = m_pret + m_ass;
            let cout_credit = (m_tot * duree * 12) - K;

            document.getElementById('res_mensualite').innerText = formatMoney(m_tot) + " ‚Ç¨";
            document.getElementById('res_frais_annexes').innerText = formatMoney(notaire + agence) + " ‚Ç¨";
            document.getElementById('res_financer').innerText = formatMoney(K) + " ‚Ç¨";

            let endettement = 0; if(rev > 0) endettement = (m_tot / rev) * 100;
            let badge = document.getElementById('badge_endettement');
            badge.innerText = endettement.toFixed(1) + "% Endettement";
            if(endettement <= 35) { badge.style.background = "rgba(16,185,129,0.2)"; badge.style.color="#34d399"; }
            else { badge.style.background = "rgba(239,68,68,0.2)"; badge.style.color="#f87171"; }

            let p_int = 30; 
            document.getElementById('chart-bg').style.background = `conic-gradient(var(--chart-capital) 0% 60%, var(--chart-interest) 60% 90%, var(--chart-insurance) 90% 100%)`;
            
            window.lastCalc = { K, taux, duree, m_pret, m_tot, m_ass, notaire, cout_credit, prix, agence, apport };
        }

        // --- YIELD + FISCALITE ---
        function calcYield() {
            let p = parseFloat(document.getElementById('y_prix').value) || 0;
            let l = parseFloat(document.getElementById('y_loyer').value) || 0;
            let c = parseFloat(document.getElementById('y_charges').value) || 0;
            let cred = parseFloat(document.getElementById('y_credit').value) || 0;
            let tmi = parseFloat(document.getElementById('y_tmi').value) || 0;
            let regime = document.getElementById('y_regime').value;
            const gestionRate = parseFloat(document.getElementById('y_gestion_rate').value) / 100 || 0;

            let an_rent = l * 12;
            let gestionAnnuelle = an_rent * gestionRate;
            let gestionMensuelle = gestionAnnuelle / 12;

            let brut = (an_rent / p) * 100;
            let net = ((an_rent - c - gestionAnnuelle)/p)*100; 
            
            let cf_brut = l - cred - (c/12) - gestionMensuelle;

            // Calcul Imp√¥t (Simplifi√© LMNP)
            let impot = 0;
            let csg = 0.172; 
            
            if(regime === 'micro') {
                let base = an_rent * 0.5;
                impot = base * ( (tmi/100) + csg );
            } else {
                let amortissement = p * 0.025; 
                let interet_estime = p * 0.03; 
                let base = an_rent - c - gestionAnnuelle - interet_estime - amortissement;
                if(base < 0) base = 0;
                impot = base * ( (tmi/100) + csg );
            }
            
            let impot_mensuel = impot / 12;
            let cf_net = cf_brut - impot_mensuel;

            document.getElementById('y_brut').innerText = brut.toFixed(1) + "%";
            document.getElementById('y_net').innerText = net.toFixed(1) + "%";
            document.getElementById('y_cashflow_brut').innerText = Math.round(cf_brut) + " ‚Ç¨";
            
            let cfNetEl = document.getElementById('y_cashflow_net');
            cfNetEl.innerText = (cf_net>0?"+":"") + Math.round(cf_net) + " ‚Ç¨";
            cfNetEl.style.color = cf_net >= 0 ? "var(--success)" : "var(--danger)";
            
            document.getElementById('y_impot_detail').innerText = `Imp√¥t estim√© : ${Math.round(impot_mensuel)} ‚Ç¨/mois`;
        }

        function calcDPE() {
            let an = parseInt(document.getElementById('dpe_annee').value); let ch = document.getElementById('dpe_chauffage').value; let score = 0;
            if(an <= 1970) score = 450; else if(an <= 1990) score = 250; else if(an <= 2010) score = 150; else score = 80;
            if(ch === 'elec') score *= 1.1; if(ch === 'pac') score *= 0.6;
            let l = 'A', c = 'var(--dpe-a)', t = 'Excellent';
            if(score > 420) { l='G'; c='var(--dpe-g)'; t='Passoire thermique'; } else if(score > 330) { l='F'; c='var(--dpe-f)'; t='Passoire thermique'; } else if(score > 250) { l='E'; c='var(--dpe-e)'; t='Moyen'; } else if(score > 180) { l='D'; c='var(--dpe-d)'; t='Standard'; } else if(score > 110) { l='C'; c='var(--dpe-c)'; t='Bon'; }
            let badge = document.getElementById('dpe_badge'); badge.innerText = l; badge.style.background = c; document.getElementById('dpe_text').innerText = t;
        }
        
        // --- MAINTENANCE / RISK CALCULATION ---
        function calcMaintenance() {
            const loyerAnnuel = parseFloat(document.getElementById('maint_loyer_annuel').value) || 0;
            const vacanceRate = parseFloat(document.getElementById('maint_vacance_rate').value) / 100 || 0;
            const prixAchat = parseFloat(document.getElementById('maint_prix_achat').value) || 0;
            const etat = document.getElementById('maint_etat').value;

            // 1. Provision Vacance Locative
            const provisionVacance = loyerAnnuel * vacanceRate;
            
            // 2. Provision Travaux (bas√©e sur % du prix d'achat)
            let travauxRate = 0.01; // Default
            if (etat === 'neuf') travauxRate = 0.005; // 0.5%
            else if (etat === 'bon') travauxRate = 0.01; // 1.0%
            else if (etat === 'moyen') travauxRate = 0.015; // 1.5%
            else if (etat === 'vieux') travauxRate = 0.02; // 2.0%
            
            const provisionTravaux = prixAchat * travauxRate;

            // Total annuel
            const totalAnnuel = provisionVacance + provisionTravaux;
            const totalMensuel = totalAnnuel / 12;

            // Update UI
            document.getElementById('maint_vac_annuel').innerText = formatMoney(provisionVacance) + " ‚Ç¨";
            document.getElementById('maint_travaux_annuel').innerText = formatMoney(provisionTravaux) + " ‚Ç¨";
            document.getElementById('maint_total_annuel').innerText = formatMoney(totalAnnuel) + " ‚Ç¨";
            document.getElementById('maint_total_mensuel').innerText = formatMoney(totalMensuel) + " ‚Ç¨";
        }
        
        // --- ACQUISITION RATE CALCULATION (NOUVEAU) ---
        function calcAcquisition() {
            const apport = parseFloat(document.getElementById('acq_apport').value) || 0;
            const cashflow = parseFloat(document.getElementById('acq_cashflow').value) || 0;
            
            const acqYearsEl = document.getElementById('acq_years');
            const acqMonthsEl = document.getElementById('acq_months');

            if (cashflow <= 0) {
                acqYearsEl.innerText = '‚àû';
                acqMonthsEl.innerText = "Cashflow N√©gatif (Impossible)";
                acqYearsEl.parentElement.style.backgroundColor = '#fecaca';
                acqYearsEl.parentElement.style.color = 'var(--danger)';
                acqYearsEl.style.color = 'var(--danger)';
                return;
            }

            const totalMonths = apport / cashflow;
            
            const years = Math.floor(totalMonths / 12);
            const months = Math.round(totalMonths % 12);

            acqYearsEl.parentElement.style.backgroundColor = '#e0f2fe';
            acqYearsEl.parentElement.style.color = 'var(--primary-dark)';
            acqYearsEl.style.color = 'var(--success)';
            
            if (years >= 1) {
                acqYearsEl.innerText = `${years} ans`;
                acqMonthsEl.innerText = `et ${months} mois`;
            } else {
                 acqYearsEl.innerText = `${Math.round(totalMonths)} mois`;
                 acqMonthsEl.innerText = `(Moins d'un an)`;
            }

            if (years === 0 && months === 0) {
                acqYearsEl.innerText = '0 mois';
                acqMonthsEl.innerText = '';
            }
        }


        // --- URL SHARING & LOADING ---
        function updateURL(section) {
            // Logic to update URL based on current calculator values
        }

        function shareSimulation() {
            const params = new URLSearchParams();
            params.set('p', document.getElementById('prix_bien').value);
            params.set('a', document.getElementById('apport').value);
            params.set('d', document.getElementById('duree').value);
            params.set('t', document.getElementById('taux').value);
            params.set('tab', 'calculator');
            
            const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            navigator.clipboard.writeText(url).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            });
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            if(params.has('p')) {
                document.getElementById('prix_bien').value = params.get('p');
                document.getElementById('apport').value = params.get('a');
                document.getElementById('duree').value = params.get('d');
                document.getElementById('taux').value = params.get('t');
                updateVal('duree_val', params.get('d'), '');
                calculate();
                if(params.get('tab') === 'patrimoine') navTo('patrimoine');
                else navTo('calculator', document.querySelectorAll('.nav-link')[1]);
            } else {
                navTo('home', document.querySelectorAll('.nav-link')[0]); // Start on home
            }
        }

        // --- PDF ---
        async function generatePDF() {
            // PDF generation logic (same as v24)
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = window.lastCalc;
            if (!data || !data.K) { alert("Veuillez faire une simulation."); return; }

            // En-t√™te
            doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 35, 'F');
            doc.setFont("helvetica", "bold"); doc.setFontSize(20); doc.setTextColor(255, 255, 255);
            doc.text("HORIZON PIERRE", 15, 18);
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text("√âtude de Financement Immobilier", 15, 26);
            doc.text(`Le ${new Date().toLocaleDateString()}`, 170, 18);

            let y = 50;

            // SECTION 1: LE CO√õT (Ce que je paie)
            doc.setTextColor(0); doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text("1. Co√ªt Total de l'Op√©ration", 15, y);
            doc.setLineWidth(0.5); doc.line(15, y+2, 195, y+2);
            y += 10;
            
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text("Prix Net Vendeur :", 20, y); doc.text(`${formatMoney(data.prix)} ‚Ç¨`, 160, y, {align:'right'}); y+=8;
            doc.text("Frais d'Agence :", 20, y); doc.text(`${formatMoney(data.agence)} ‚Ç¨`, 160, y, {align:'right'}); y+=8;
            doc.text("Frais de Notaire (Estim√©s) :", 20, y); doc.text(`${formatMoney(data.notaire)} ‚Ç¨`, 160, y, {align:'right'}); y+=10;
            
            doc.setFillColor(240); doc.rect(15, y-6, 180, 10, 'F');
            doc.setFont("helvetica", "bold"); 
            let totalCout = parseFloat(data.prix) + parseFloat(data.agence) + parseFloat(data.notaire);
            doc.text("TOTAL DU PROJET :", 20, y); doc.text(`${formatMoney(totalCout)} ‚Ç¨`, 160, y, {align:'right'}); y+=20;

            // SECTION 2: LE FINANCEMENT (Comment je paie)
            doc.setFontSize(14); doc.text("2. Plan de Financement", 15, y);
            doc.line(15, y+2, 195, y+2); y += 10;
            
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text("Votre Apport Personnel :", 20, y); doc.text(`- ${formatMoney(data.apport)} ‚Ç¨`, 160, y, {align:'right'}); y+=8;
            
            doc.setFillColor(230, 240, 255); doc.rect(15, y-2, 180, 14, 'F');
            doc.setFont("helvetica", "bold"); doc.setTextColor(15, 23, 42);
            doc.text("MONTANT √Ä EMPRUNTER :", 20, y+8); doc.text(`${formatMoney(data.K)} ‚Ç¨`, 160, y+8, {align:'right'}); y+=25;

            // SECTION 3: EMPRUNT
            doc.setTextColor(0);
            doc.setFontSize(14); doc.text("3. Conditions de l'Emprunt", 15, y);
            doc.line(15, y+2, 195, y+2); y += 12;

            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            doc.text(`Mensualit√© (Assurance Incluse) : ${formatMoney(data.m_tot)} ‚Ç¨ / mois`, 20, y); y+=8;
            doc.text(`Taux Nominal : ${document.getElementById('taux').value} %  |  Dur√©e : ${data.duree} ans`, 20, y); y+=8;
            doc.text(`Co√ªt total des int√©r√™ts + assurance : ${formatMoney(data.cout_credit)} ‚Ç¨`, 20, y); y+=20;

            // SECTION 4: TABLEAU COMPLET
            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text("4. Tableau d'Amortissement Pr√©visionnel (Complet)", 15, y);
            y += 5;

            let rows = []; let solde = data.K; let tm = data.taux / 12;
            for(let an=1; an<= data.duree; an++) {
                let int_an = 0; let cap_an = 0;
                for(let m=0; m<12; m++) {
                    let int = solde * tm; let cap = data.m_pret - int;
                    int_an += int; cap_an += cap; solde -= cap; if(solde < 0) solde = 0;
                }
                rows.push([`Ann√©e ${an}`, `${formatMoney(solde)} ‚Ç¨`, `${formatMoney(int_an)} ‚Ç¨`, `${formatMoney(cap_an)} ‚Ç¨`]);
            }

            doc.autoTable({ startY: y, head: [['Ann√©e', 'Restant D√ª', 'Int√©r√™ts', 'Capital']], body: rows, theme: 'striped', headStyles: { fillColor: [15, 23, 42] }, styles: { fontSize: 10, cellPadding: 3 }, pageBreak: 'auto' });

            doc.save("Etude_HorizonPierre_Complete.pdf");
        }

        function openTableModal() { 
            document.getElementById('table-modal').classList.add('show'); /* Utilisation de la classe show */
            generateTable(); 
        }
        function closeTableModal() { 
            document.getElementById('table-modal').classList.remove('show'); /* Retrait de la classe show */
        }
        function generateTable() {
            let { K, taux, duree, m_pret } = window.lastCalc || {}; if(!K) return;
            let html = ''; let solde = K; let tm = taux / 12;
            for(let an=1; an<=duree; an++) {
                let int_an = 0; let cap_an = 0;
                for(let m=0; m<12; m++) { let int = solde * tm; let cap = m_pret - int; int_an += int; cap_an += cap; solde -= cap; if(solde < 0) solde = 0; }
                html += `<tr><td>Ann√©e ${an}</td><td>${formatMoney(solde)} ‚Ç¨</td><td>${formatMoney(m_pret)} ‚Ç¨</td><td>${formatMoney(int_an)} ‚Ç¨</td><td><strong style="color:var(--success)">${formatMoney(cap_an)} ‚Ç¨</strong></td></tr>`;
            }
            document.getElementById('amortization-body').innerHTML = html;
        }

        // Init: Load data from URL if present, otherwise start on home
        // Rendu inutile par le doc.addEventListener('DOMContentLoaded')
        // loadFromURL(); 
    </script>
</body>
</html>
